<document xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://petriflow.com/petriflow.schema.xsd">
    <id>tabbed_ticket_view_configuration</id>
    <initials>TVC</initials>
    <title>Tabbed ticket view configuration</title>
    <icon>check_box_outline_blank</icon>
    <defaultRole>true</defaultRole>
    <anonymousRole>false</anonymousRole>
    <transitionRole>false</transitionRole>
    <roleRef>
        <id>system</id>
        <caseLogic>
            <create>true</create>
            <delete>true</delete>
            <view>true</view>
        </caseLogic>
    </roleRef>
    <roleRef>
        <id>admin</id>
        <caseLogic>
            <create>true</create>
            <delete>true</delete>
            <view>true</view>
        </caseLogic>
    </roleRef>
    <roleRef>
        <id>default</id>
        <caseLogic>
            <create>false</create>
            <delete>false</delete>
            <view>true</view>
        </caseLogic>
    </roleRef>
    <caseEvents>
        <event type="delete">
            <id>view_delete</id>
            <actions phase="pre">
                <action id="0">
                    removeViewCase()
                </action>
            </actions>
        </event>
    </caseEvents>
    <role>
        <id>system</id>
        <title>System</title>
    </role>
    <role>
        <id>admin</id>
        <title>Admin</title>
    </role>

    <function scope="process" name="updateFilterAutocompleteOptions">
        {
            com.netgrif.application.engine.petrinet.domain.dataset.EnumerationMapField filterAutocomplete,
            com.netgrif.application.engine.petrinet.domain.dataset.TaskField previewTaskRef,
            com.netgrif.application.engine.petrinet.domain.dataset.CaseField selectedFilterRef,
            com.netgrif.application.engine.petrinet.domain.dataset.ButtonField updateBtn,
            com.netgrif.application.engine.petrinet.domain.Transition trans
                ->
                if (filterAutocomplete.getOptions().containsKey(filterAutocomplete.value)) {
                    change previewTaskRef value {
                        return [findTask({it.caseId.eq(filterAutocomplete.value).and(it.transitionId.eq("view_filter"))}).stringId]
                    }
                    make updateBtn,editable on trans when { true }
                } else {
                    change filterAutocomplete options {
                        def findAllPredicate = { filterCase -> !selectedFilterRef.value.contains(filterCase.stringId)
                                &amp;&amp; filterCase.dataSet["filter_type"].value == "Case" }
                        return findFilters(filterAutocomplete.value != null ? filterAutocomplete.value : "")
                                .findAll(findAllPredicate)
                                .collectEntries({filterCase -&gt; [filterCase.stringId, filterCase.title]})
                    }
                    change previewTaskRef value { [] }
                    make updateBtn,visible on trans when { true }
                }
        }
    </function>
    <function scope="process" name="removeViewCase">
        { ->

            def viewIdAsList = useCase.dataSet['view_configuration_id'].value
            if (viewIdAsList == null || viewIdAsList.isEmpty()) {
                return
            }

            async.run {
                workflowService.deleteCase(viewIdAsList[0])
            }
        }
    </function>

    <!-- FILTER configuration data -->
    <data type="taskRef">
        <id>selected_filter_preview</id>
        <title/>
    </data>
    <data type="taskRef">
        <id>current_filter_preview</id>
        <title/>
    </data>
    <data type="i18n">
        <id>filter_header</id>
        <title/>
        <init name="filter_header">Current filter</init>
        <component>
            <name>divider</name>
        </component>
    </data>
    <data type="text">
        <id>new_filter_id</id>
        <title/>
    </data>
    <data type="boolean" immediate="true">
        <id>contains_filter</id>
        <title/>
        <init>false</init>
    </data>
    <data type="enumeration_map">
        <id>filter_autocomplete_selection</id>
        <title name="filter_autocomplete_selection">Select new filter</title>
        <component>
            <name>autocomplete_dynamic</name>
        </component>
        <action trigger="set">
            trans: t.settings,
            filterAutocomplete: f.this,
            filter_case: f.filter_case,
            update_filter: f.update_filter,
            previewTaskRef: f.selected_filter_preview;

            updateFilterAutocompleteOptions(filterAutocomplete, previewTaskRef, filter_case, update_filter, trans)
        </action>
        <action trigger="get">
            trans: t.settings,
            filterAutocomplete: f.this,
            filter_case: f.filter_case,
            update_filter: f.update_filter,
            previewTaskRef: f.selected_filter_preview;

            updateFilterAutocompleteOptions(filterAutocomplete, previewTaskRef, filter_case, update_filter, trans)
        </action>
    </data>
    <data type="button">
        <id>update_filter</id>
        <title/>
        <placeholder name="update_filter">Update view with selected filter</placeholder>
        <component>
            <name>raised</name>
        </component>
        <action trigger="set">
            trans: t.settings,
            update_filter: f.update_filter,
            contains_filter: f.contains_filter,
            filter_case: f.filter_case,
            filterAutocomplete: f.filter_autocomplete_selection;

            boolean containsFilter = filterAutocomplete.value != null &amp;&amp; filterAutocomplete.value != ""
            if (containsFilter) {
                def filterCase = findCase({it._id.eq(filterAutocomplete.value)})
                if (filterCase.dataSet["filter_type"].value != "Case") {
                    throw new IllegalArgumentException("Filter is of wrong type. Only filter of Case type allowed.")
                }
            }

            change contains_filter value { containsFilter }
            change filter_case value { [filterAutocomplete.value] }
            change filterAutocomplete value { "" }
            make update_filter,visible on trans when { true }
        </action>
    </data>
    <data type="caseRef">
        <id>filter_case</id>
        <title/>
        <action trigger="set">
            filterTaskRef: f.current_filter_preview,
            contains_filter: f.contains_filter,
            filterCaseRef: f.filter_case;

            if (filterCaseRef.value == null || filterCaseRef.value == []) {
                change filterTaskRef value { [] }
                change contains_filter value { false }
                return
            }

            def filterCase = findCase({it._id.eq(filterCaseRef.value[0])})
            change filterTaskRef value {
                return [findTask({it.caseId.eq(filterCase.stringId).and(it.transitionId.eq("view_filter"))}).stringId]
            }
            change contains_filter value { true }
        </action>
        <allowedNets>
            <allowedNet>filter</allowedNet>
        </allowedNets>
    </data>

    <!-- ASSOCIATED VIEW: this section can be removed if needed -->
    <data type="enumeration_map" immediate="true">
        <id>view_configuration_type</id>
        <title name="view_configuration_type">Pick view type</title>
        <options>
            <init dynamic="true">menuItemService.getAvailableViewsAsOptions(true, useCase.processIdentifier)</init>
        </options>
        <action trigger="set">
            view_configuration_type: f.view_configuration_type;

            if (view_configuration_type.options == null || view_configuration_type.options.isEmpty()) {
                change view_configuration_type options { menuItemService.getAvailableViewsAsOptions(true) }
            }
        </action>
    </data>
    <data type="caseRef">
        <id>view_configuration_id</id>
        <title/>
        <allowedNets>
            <allowedNet>tabbed_single_task_view_configuration</allowedNet>
        </allowedNets>
    </data>
    <data type="taskRef">
        <id>view_configuration_form</id>
        <title/>
    </data>
    <!-- END OF ASSOCIATED VIEW -->

    <!-- VIEW CONFIGURATION DATA -->
    <data type="i18n">
        <id>view_header</id>
        <title/>
        <init name="view_header">Ticket view</init>
        <component>
            <name>divider</name>
        </component>
    </data>
    <!-- END OF VIEW CONFIGURATION DATA -->

    <!-- I18NS -->
    <i18n locale="sk">
        <i18nString name="filter_autocomplete_selection">Zvoľte nový filter</i18nString>
        <i18nString name="update_filter">Aktualizovať zobrazenie s vybraným filtrom</i18nString>
        <i18nString name="filter_update_title">Filter</i18nString>
        <i18nString name="filter_header">Súčasný filter</i18nString>
        <i18nString name="view_configuration_type">Vybrať zobrazenie</i18nString>
        <i18nString name="settings">Nastavenie</i18nString>
        <i18nString name="associated_view">Asociované zobrazenie</i18nString>
        <i18nString name="view_header">Tiketové zobrazenie</i18nString>
    </i18n>
    <i18n locale="de">
        <i18nString name="filter_autocomplete_selection">Neue Filter auswählen</i18nString>
        <i18nString name="filter_update_title">Filter</i18nString>
        <i18nString name="filter_header">Aktueller Filter</i18nString>
        <i18nString name="update_filter">Aktualisiere die Ansicht mit dem ausgewählten Filter</i18nString>
        <i18nString name="view_configuration_type">Wählen Sie einen Ansichtstyp</i18nString>
        <i18nString name="settings">Einstellungen</i18nString>
        <i18nString name="associated_view">zugehörige Ansicht</i18nString>
        <i18nString name="view_header">Ticketansicht</i18nString>
    </i18n>

    <transition>
        <id>initialize</id>
        <x>368</x>
        <y>208</y>
        <label>initialize [await sync]</label>
        <icon>hourglass_empty</icon>
    </transition>
    <transition>
        <id>data_sync</id>
        <x>368</x>
        <y>328</y>
        <label>Data sync</label>
    </transition>
    <transition>
        <id>settings</id>
        <x>496</x>
        <y>112</y>
        <label name="settings">Settings</label>
        <icon>settings</icon>
        <roleRef>
            <id>admin</id>
            <logic>
                <perform>true</perform>
                <view>true</view>
                <cancel>true</cancel>
                <assign>true</assign>
            </logic>
        </roleRef>
        <dataGroup>
            <id>form_title</id>
            <cols>4</cols>
            <layout>grid</layout>
            <dataRef>
                <id>view_header</id>
                <logic>
                    <behavior>visible</behavior>
                </logic>
                <layout>
                    <x>0</x>
                    <y>0</y>
                    <rows>1</rows>
                    <cols>4</cols>
                    <template>material</template>
                    <appearance>outline</appearance>
                </layout>
            </dataRef>
        </dataGroup>
        <dataGroup>
            <id>associated_view</id>
            <cols>4</cols>
            <layout>grid</layout>
            <title name="associated_view">Associated view</title>
            <dataRef>
                <id>view_configuration_type</id>
                <logic>
                    <behavior>editable</behavior>
                </logic>
                <layout>
                    <x>0</x>
                    <y>0</y>
                    <rows>1</rows>
                    <cols>4</cols>
                    <offset>0</offset>
                    <template>material</template>
                    <appearance>outline</appearance>
                </layout>
                <event type="set">
                    <id>0</id>
                    <actions phase="post">
                        <action>
                            view_configuration_type: f.view_configuration_type,
                            view_configuration_form: f.view_configuration_form,
                            view_configuration_id: f.view_configuration_id;

                            if (view_configuration_id.value != null &amp;&amp; !view_configuration_id.value.isEmpty()) {
                                workflowService.deleteCase(view_configuration_id.value[0])
                            }

                            if (view_configuration_type.value == null || view_configuration_type.value == "") {
                                change view_configuration_id value { [] }
                                change view_configuration_form value { [] }
                                return
                            }

                            def configurationCase = createCase(view_configuration_type.value + "_configuration")
                            def initTask = assignTask("initialize", configurationCase)
                            finishTask(initTask)
                            change view_configuration_id value { [configurationCase.stringId] }
                            configurationCase = workflowService.findOne(configurationCase.stringId)
                            change view_configuration_form value { [configurationCase.tasks.find { it.transition == "settings" }.task] }
                        </action>
                    </actions>
                </event>
            </dataRef>
            <dataRef>
                <id>view_configuration_form</id>
                <logic>
                    <behavior>editable</behavior>
                </logic>
                <layout>
                    <x>0</x>
                    <y>1</y>
                    <rows>1</rows>
                    <cols>4</cols>
                    <offset>0</offset>
                    <template>material</template>
                    <appearance>outline</appearance>
                </layout>
            </dataRef>
        </dataGroup>
    </transition>
    <place>
        <id>initialized</id>
        <x>496</x>
        <y>208</y>
        <label>initialized</label>
        <tokens>0</tokens>
        <static>false</static>
    </place>
    <place>
        <id>uninitialized</id>
        <x>240</x>
        <y>208</y>
        <label>uninitialized</label>
        <tokens>1</tokens>
        <static>false</static>
    </place>
    <arc>
        <id>a1</id>
        <type>read</type>
        <sourceId>initialized</sourceId>
        <destinationId>settings</destinationId>
        <multiplicity>1</multiplicity>
    </arc>
    <arc>
        <id>a2</id>
        <type>regular</type>
        <sourceId>uninitialized</sourceId>
        <destinationId>initialize</destinationId>
        <multiplicity>1</multiplicity>
    </arc>
    <arc>
        <id>a3</id>
        <type>regular</type>
        <sourceId>initialize</sourceId>
        <destinationId>initialized</destinationId>
        <multiplicity>1</multiplicity>
    </arc>
</document>