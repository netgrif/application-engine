<document xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://petriflow.com/petriflow.schema.xsd">
	<id>transaction_test</id>
	<version>1.0.0</version>
	<initials>TRN</initials>
	<title>transaction_test</title>
	<icon>device_hub</icon>
	<defaultRole>true</defaultRole>
	<anonymousRole>true</anonymousRole>
	<transitionRole>false</transitionRole>

	<data type="text">
		<id>text_without_action</id>
		<title/>
	</data>
	<data type="text">
		<id>text_2</id>
		<title/>
	</data>

	<data type="boolean">
		<id>was_transaction_rolled_back</id>
		<title/>
	</data>

	<data type="button">
		<id>testBasicTransaction</id>
		<title/>
		<event type="set">
			<id>testBasicTransaction</id>
			<actions phase="post">
				<action>
					was_transaction_rolled_back: f.was_transaction_rolled_back,
					text_without_action: f.text_without_action;

					def myTransaction = transaction(
						event: {
							createCase("transaction_test", "onButton")
							change text_without_action value { "xxx" }
						},
						onCommit: { createCase("transaction_test", "onCommit") },
						onRollBack: { createCase("transaction_test", "onRollBack") }
					)
					createCase("transaction_test", "onAlways")

					change was_transaction_rolled_back value { myTransaction.wasRolledBack }
				</action>
			</actions>
		</event>
	</data>

	<data type="button">
		<id>testBasicTransactionWithFailure</id>
		<title/>
		<event type="set">
			<id>testBasicTransactionWithFailure</id>
			<actions phase="post">
				<action>
					was_transaction_rolled_back: f.was_transaction_rolled_back,
					text_without_action: f.text_without_action;

					def myTransaction = transaction(
						event: {
							workflowService.deleteCase(findCase({it.title.eq("toBeRemoved")}))
							createCase("transaction_test", "onButton")
							change text_without_action value { "xxx" }
							// not runtime exception on purpose
							throw new IllegalAccessException("error")
						},
						onCommit: { createCase("transaction_test", "onCommit") },
						onRollBack: { createCase("transaction_test", "onRollBack") }
					)
					createCase("transaction_test", "onAlways")

					change was_transaction_rolled_back value { myTransaction.wasRolledBack }
				</action>
			</actions>
		</event>
	</data>

	<data type="button">
		<id>testFailureInCallBackThrowsError</id>
		<title/>
		<event type="set">
			<id>testFailureInCallBackThrowsError</id>
			<actions phase="post">
				<action>
					was_transaction_rolled_back: f.was_transaction_rolled_back,
					text_without_action: f.text_without_action;

					def myTransaction = transaction(
						event: {
							createCase("transaction_test", "onButton")
							change text_without_action value { "xxx" }
							throw new RuntimeException("error")
						},
						onCommit: { createCase("transaction_test", "onCommit") },
						onRollBack: {
							throw new RuntimeException("error")
							createCase("transaction_test", "onRollBack")
						}
					)
					createCase("transaction_test", "onAlways")

					change was_transaction_rolled_back value { myTransaction.wasRolledBack }
				</action>
			</actions>
		</event>
	</data>

	<data type="button">
		<id>testTimeout</id>
		<title/>
		<event type="set">
			<id>testTimeout</id>
			<actions phase="post">
				<action>
					was_transaction_rolled_back: f.was_transaction_rolled_back,
					text_without_action: f.text_without_action;

					def myTransaction = transaction(
						timeout: 1, // in millis
						event: {
							createCase("transaction_test", "onButton")
							Thread.sleep(50) // make sure it will time-out
						},
						onCommit: { createCase("transaction_test", "onCommit") },
						onRollBack: { createCase("transaction_test", "onRollBack") }
					)
					createCase("transaction_test", "onAlways")

					change was_transaction_rolled_back value { myTransaction.wasRolledBack }
				</action>
			</actions>
		</event>
	</data>

	<data type="button">
		<id>testElasticIndexingOnTransactionFailure</id>
		<title/>
		<event type="set">
			<id>testElasticIndexingOnTransactionFailure</id>
			<actions phase="post">
				<action>
					was_transaction_rolled_back: f.was_transaction_rolled_back,
					text_without_action: f.text_without_action;

					def myTransaction = transaction(
						event: {
							petriNetService.importPetriNet(new java.io.FileInputStream("src/test/resources/petriNets/transaction/transaction_test_secondary.xml"),
									com.netgrif.application.engine.petrinet.domain.VersionType.MAJOR, userService.getLoggedOrSystem().transformToLoggedUser())
							def toBeRemovedCase = createCase("transaction_test_secondary", "toBeRemoved")
							assignTask("t1", toBeRemovedCase)
							workflowService.deleteCase(toBeRemovedCase.stringId)

							createCase("transaction_test", "onButton")
							throw new RuntimeException("error")
						},
						onCommit: { createCase("transaction_test", "onCommit") },
						onRollBack: { createCase("transaction_test", "onRollBack") }
					)
					createCase("transaction_test", "onAlways")

					change was_transaction_rolled_back value { myTransaction.wasRolledBack }
				</action>
			</actions>
		</event>
	</data>

	<data type="button">
		<id>testElasticIndexingOnTransactionSuccess</id>
		<title/>
		<event type="set">
			<id>testElasticIndexingOnTransactionSuccess</id>
			<actions phase="post">
				<action>
					was_transaction_rolled_back: f.was_transaction_rolled_back,
					text_without_action: f.text_without_action;

					def myTransaction = transaction(
							event: {
								petriNetService.importPetriNet(new java.io.FileInputStream("src/test/resources/petriNets/transaction/transaction_test_secondary.xml"),
										com.netgrif.application.engine.petrinet.domain.VersionType.MAJOR, userService.getLoggedOrSystem().transformToLoggedUser())
								def toBeRemovedCase = createCase("transaction_test_secondary", "toBeRemoved")
								assignTask("t1", toBeRemovedCase)
								workflowService.deleteCase(toBeRemovedCase.stringId)

								createCase("transaction_test", "onButton")
							},
							onCommit: { createCase("transaction_test", "onCommit") },
							onRollBack: { createCase("transaction_test", "onRollBack") }
					)
					createCase("transaction_test", "onAlways")

					change was_transaction_rolled_back value { myTransaction.wasRolledBack }
				</action>
			</actions>
		</event>
	</data>

	<transition>
		<id>t1</id>
		<x>496</x>
		<y>144</y>
		<label>t1</label>
	</transition>
</document>